# CTIS TAXII Splunk App
## Background

Splunk Platform App to support STIX v2 based threat intelligence (Indicators of Compromise) sharing with TAXII v2 servers.

Specifically intended to support contribution to the ASD's CTIS platform.

## Splunk Admin/User Documentation
Please see https://splunk.github.io/ctis-taxii-splunk-app for user-facing documentation.

# Development Notes
This app combines SplunkUI Toolkit and UCC Framework to create a custom Splunk app.

## Setup
- Install `splunk-add-on-ucc-framework` pip package. See https://splunk.github.io/addonfactory-ucc-generator/#installation
- SplunkUI Toolkit requirements: https://splunkui.splunk.com/Toolkits/SUIT/Overview
- rsync is required for the `copy-ui-to-ucc-app.sh` script
- For Mac OS, install gnu-sed: https://formulae.brew.sh/formula/gnu-sed
  - Build scripts used GNU sed syntax: https://stackoverflow.com/a/43453459/23523267
  - Make sure to have `sed` in path refer to the brew version not the default mac version

### Run Unit Tests Locally
```bash
# Assuming you have a Python virtual environment already set up (3.9+)

# Includes pytest & pytest-cov
pip install -r dev-requirements.txt

# Includes all dependencies to run the app
pip install -r TA_CTIS_TAXII/package/lib/requirements.txt

python -m pytest -v TA_CTIS_TAXII/test/ --cov=TA_CTIS_TAXII/test/
```
 
## Build
```bash
# Just run the full build script from project root
# Read the script code for details
./full-build.sh
```

May need to restart Splunk to see new views added to nav.
Alternatively can try:
- http://localhost:8001/en-GB/_bump
- http://localhost:8001/en-GB/debug/refresh

## Adding new views
- Add files to the SplunkUI app `packages/my-splunk-app`
  - HTML template: `packages/my-splunk-app/src/main/resources/splunk/appserver/templates/new-view.html`
  - XML view: `packages/my-splunk-app/src/main/resources/splunk/default/data/ui/views/new-view.xml`
  - JS/JSX: `packages/my-splunk-app/src/main/webapp/pages/new-view/index.jsx` and relevant js files
- Update the `default.xml` in the UCC app: `TA_CTIS_TAXII/package/default/data/ui/nav/default.xml`
- rebuild with the full build script
- restart Splunk
- Troubleshoot: May need to delete existing UCC output folder and rerun build script

## Custom REST endpoints
Endpoints exposed on web port require Splunk cookies to access via `web.conf`.
E.g. `http://localhost:8001/en-GB/splunkd/__raw/servicesNS/nobody/TA_CTIS_TAXII/say-hello?output_mode=json`
You can test this after logging into Splunk and using devtools console.
E.g.
```javascript
const resp = await fetch('http://localhost:8001/en-GB/splunkd/__raw/servicesNS/nobody/TA_CTIS_TAXII/say-hello?output_mode=json')
const json = await resp.json()
console.log(resp, json)
```

## The following is autogenerated by Splunk UI:

## Overview

The project contains a variety of packages that are published and versioned collectively. Each package lives in its own 
directory in the `/packages` directory. Each package is self contained, and defines its dependencies in a package.json file.

We use [Yarn Workspaces](https://yarnpkg.com/lang/en/docs/workspaces/) and [Lerna](https://github.com/lerna/lerna) for
managing and publishing multiple packages in the same repository.


## Getting Started

1. Clone the repo.
2. Install yarn (>= 1.2) if you haven't already: `npm install --global yarn`.
3. Run the setup task: `yarn run setup`.

After this step, the following tasks will be available:

* `start` – Run the `start` task for each project
* `build` – Create a production bundle for all projects
* `test` – Run unit tests for each project
* `lint` – Run JS and CSS linters for each project
* `format` – Run prettier to auto-format `*.js`, `*.jsx` and `*.css` files. This command will overwrite files without 
asking, `format:verify` won't.

Running `yarn run setup` once is required to enable all other tasks. The command might take a few minutes to finish.


## Developer Scripts

Commands run from the root directory will be applied to all packages. This is handy when working on multiple packages 
simultaneously. Commands can also be run from individual packages. This may be better for performance and reporting when
 only working on a single package. All of the packages have similar developer scripts, but not all scripts are implemented 
 for every package. See the `package.json` of the package in question to see which scripts are available there.

For more granular control of development scripts, consider using [Lerna](https://github.com/lerna/lerna) directly.


## Code Formatting

MyReactRepo uses [prettier](https://github.com/prettier/prettier) to ensure consistent code formatting. It is recommended
 to [add a prettier plugin to your editor/ide](https://github.com/prettier/prettier#editor-integration).
